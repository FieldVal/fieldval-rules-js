function extend(e,i){function l(){}l.prototype=i.prototype;var t=new l;for(var r in t)e.prototype[r]=t[r];e.prototype.constructor=e,e.superConstructor=i,e.superClass=i.prototype}function RuleField(e,i){var l=this;if(l.json=e,l.checks=[],l.validator="undefined"!=typeof i?i:new FieldVal(e),l.name=l.validator.get("name",BasicVal.string(!1)),l.display_name=l.validator.get("display_name",BasicVal.string(!1)),l.description=l.validator.get("description",BasicVal.string(!1)),l.type=l.validator.get("type",BasicVal.string(!0)),l.required=l.validator.default_value(!0).get("required",BasicVal.boolean(!1)),null!=e){var t=l.validator.get("exists",BasicVal.boolean(!1));null!=t&&(existsFilter=t?1:2)}}function BasicRuleField(e,i){BasicRuleField.superConstructor.call(this,e,i)}function TextRuleField(e,i){TextRuleField.superConstructor.call(this,e,i)}function NumberRuleField(e,i){NumberRuleField.superConstructor.call(this,e,i)}function ObjectRuleField(e,i){ObjectRuleField.superConstructor.call(this,e,i)}function ArrayRuleField(e,i){var l=this;ArrayRuleField.superConstructor.call(this,e,i),l.rules=[],l.fields=[],l.interval=null,l.interval_offsets=[]}function ChoiceRuleField(e,i){ChoiceRuleField.superConstructor.call(this,e,i)}function BooleanRuleField(e,i){BooleanRuleField.superConstructor.call(this,e,i)}function EmailRuleField(e,i){EmailRuleField.superConstructor.call(this,e,i)}function ValidationRule(){}"undefined"!=typeof module&&(module.exports=extend),RuleField.types={},RuleField.add_field_type=function(e){RuleField.types[e.name]={display_name:e.display_name,"class":e.class}},RuleField.create_field=function(e,i){var l=null,t=BasicVal.object(!0).check(e);if(t)return[t,null];var r=new FieldVal(e);i&&void 0!==i.need_name&&i.need_name===!0&&r.get("name",BasicVal.string(!0));var a=r.get("type",BasicVal.string(!0),BasicVal.one_of(RuleField.types));if(!a)return[r.end(),null];var n=RuleField.types[a],u=n.class;l=new u(e,r);var d=l.init();return null!=d?[d,null]:[null,l]},RuleField.prototype.validate_as_field=function(e,i){var l=this,t=i.get(e,l.checks);return t},RuleField.prototype.validate=function(e){var i=this,l=new FieldVal(null),t=FieldVal.use_checks(e,i.checks);return t&&l.error(t),l.end()},RuleField.prototype.make_nested=function(){},RuleField.prototype.init=function(){},RuleField.prototype.remove=function(){},RuleField.prototype.view_mode=function(){},RuleField.prototype.edit_mode=function(){},RuleField.prototype.change_name=function(){},RuleField.prototype.disable=function(){},RuleField.prototype.enable=function(){},RuleField.prototype.focus=function(){},RuleField.prototype.blur=function(){},RuleField.prototype.val=function(){},"undefined"!=typeof module&&(module.exports=RuleField),"function"==typeof require&&(extend=require("extend")),extend(BasicRuleField,RuleField),BasicRuleField.prototype.init=function(){var e=this;return e.ui_field.init.apply(e.ui_field,arguments)},BasicRuleField.prototype.remove=function(){var e=this;return e.ui_field.remove.apply(e.ui_field,arguments)},BasicRuleField.prototype.in_array=function(){var e=this;return e.ui_field.in_array.apply(e.ui_field,arguments)},BasicRuleField.prototype.view_mode=function(){var e=this;return e.ui_field.view_mode.apply(e.ui_field,arguments)},BasicRuleField.prototype.edit_mode=function(){var e=this;return e.ui_field.edit_mode.apply(e.ui_field,arguments)},BasicRuleField.prototype.change_name=function(){var e=this;return e.ui_field.change_name.apply(e.ui_field,arguments)},BasicRuleField.prototype.disable=function(){var e=this;return e.ui_field.disable.apply(e.ui_field,arguments)},BasicRuleField.prototype.val=function(){var e=this;return e.ui_field.val.apply(e.ui_field,arguments)},BasicRuleField.prototype.error=function(){var e=this;return e.ui_field.error.apply(e.ui_field,arguments)},BasicRuleField.prototype.blur=function(){var e=this;return e.ui_field.blur.apply(e.ui_field,arguments)},BasicRuleField.prototype.focus=function(){var e=this;return e.ui_field.blur.apply(e.ui_field,arguments)},"undefined"!=typeof module&&(module.exports=BasicRuleField),"function"==typeof require&&(extend=require("extend"),BasicRuleField=require("./BasicRuleField")),extend(TextRuleField,BasicRuleField),TextRuleField.prototype.create_ui=function(e){var i=this;return i.ui_field=new TextField(i.display_name||i.name,i.json),i.container=i.ui_field.container,e.add_field(i.name,i),i.ui_field},TextRuleField.prototype.init=function(){var e=this;return e.checks.push(BasicVal.string(e.required)),e.min_length=e.validator.get("min_length",BasicVal.integer(!1)),void 0!==e.min_length&&e.checks.push(BasicVal.min_length(e.min_length,{stop_on_error:!1})),e.max_length=e.validator.get("max_length",BasicVal.integer(!1)),void 0!==e.max_length&&e.checks.push(BasicVal.max_length(e.max_length,{stop_on_error:!1})),e.phrase=e.validator.get("phrase",BasicVal.string(!1)),e.equal_to=e.validator.get("equal_to",BasicVal.string(!1)),e.ci_equal_to=e.validator.get("ci_equal_to",BasicVal.string(!1)),e.prefix=e.validator.get("prefix",BasicVal.string(!1)),e.ci_prefix=e.validator.get("ci_prefix",BasicVal.string(!1)),e.query=e.validator.get("query",BasicVal.string(!1)),e.validator.end()},"undefined"!=typeof module&&(module.exports=TextRuleField),"function"==typeof require&&(extend=require("extend"),BasicRuleField=require("./BasicRuleField")),extend(NumberRuleField,BasicRuleField),NumberRuleField.prototype.create_ui=function(e){var i=this;return i.ui_field=new TextField(i.display_name||i.name,i.json),i.container=i.ui_field.container,e.add_field(i.name,i),i.ui_field},NumberRuleField.prototype.init=function(){var e=this;return e.checks.push(BasicVal.number(e.required)),e.minimum=e.validator.get("minimum",BasicVal.number(!1)),null!=e.minimum&&e.checks.push(BasicVal.minimum(e.minimum,{stop_on_error:!1})),e.maximum=e.validator.get("maximum",BasicVal.number(!1)),null!=e.maximum&&e.checks.push(BasicVal.maximum(e.maximum,{stop_on_error:!1})),e.integer=e.validator.get("integer",BasicVal.boolean(!1)),e.integer&&e.checks.push(BasicVal.integer(!1,{stop_on_error:!1})),e.validator.end()},"undefined"!=typeof module&&(module.exports=NumberRuleField),"function"==typeof require&&(extend=require("extend"),BasicRuleField=require("./BasicRuleField")),extend(ObjectRuleField,BasicRuleField),ObjectRuleField.prototype.create_ui=function(e,i){var l=this;if(l.json.any)l.ui_field=new TextField(l.display_name||l.name,{type:"textarea"}),l.ui_field.val=function(e){var i=this;if(0===arguments.length){var l=i.input.val();if(0===l.length)return null;try{return JSON.parse(l)}catch(t){console.error("FAILED TO PARSE: ",l)}return l}return i.input.val(JSON.stringify(e,null,4)),i},l.container=l.ui_field.container;else{l.ui_field=i?i:new ObjectField(l.display_name||l.name,l.json);for(var t in l.fields){var r=l.fields[t];r.create_ui(l.ui_field)}l.container=l.ui_field.container}return i||e.add_field(l.name,l.ui_field),l.ui_field},ObjectRuleField.prototype.init=function(){var e=this;e.checks.push(BasicVal.object(e.required)),e.fields={};var i=e.validator.get("fields",BasicVal.array(!1));if(null!=i){for(var l=new FieldVal(null),t=0;t<i.length;t++){var r=i[t],a=RuleField.create_field(r,{need_name:!0}),n=a[0],u=a[1];null==n?e.fields[u.name]=u:l.invalid(t,n)}var d=l.end();null!=d&&e.validator.invalid("fields",d)}return e.any=e.validator.get("any",BasicVal.boolean(!1)),e.any||e.checks.push(function(i){var l=new FieldVal(i);for(var t in e.fields){var r=e.fields[t];r.validate_as_field(t,l)}var a=l.end();return a}),e.validator.end()},"undefined"!=typeof module&&(module.exports=ObjectRuleField),"function"==typeof require&&(extend=require("extend"),BasicRuleField=require("./BasicRuleField"),ValidationRule=require("../ValidationRule")),extend(ArrayRuleField,BasicRuleField),ArrayRuleField.prototype.create_ui=function(e){var i=this;i.ui_field=new ArrayField(i.display_name||i.name,i.json),i.ui_field.new_field=function(e){return i.new_field(e)};var l=i.ui_field.remove_field;return i.ui_field.remove_field=function(e){for(var t=0;t<i.fields.length;t++)i.fields[t]===e&&i.fields.splice(t,1);return l.call(i.ui_field,e)},i.container=i.ui_field.container,e.add_field(i.name,i),i.ui_field},ArrayRuleField.prototype.new_field=function(e){var i=this,l=i.rule_for_index(e);return l.create_ui(i.ui_field)},ArrayRuleField.prototype.rule_for_index=function(e){var i=this,l=i.rules[e];if(!l){{var t=i.rule_json_for_index(e),r=RuleField.create_field(t);r[0]}l=r[1],i.rules[e]=l}return l},ArrayRuleField.prototype.rule_json_for_index=function(e){var i=this,l=i.indices[e];if(!l&&i.interval){var t=e%i.interval;l=i.interval_offsets[t]}return l||(l=i.indices["*"]),l},ArrayRuleField.integer_regex=/^(\d+)$/,ArrayRuleField.interval_regex=/^(\d+)n(\+(\d+))?$/,ArrayRuleField.prototype.init=function(){var e=this;e.checks.push(BasicVal.array(e.required)),e.indices={};var i=e.validator.get("indices",BasicVal.object(!1));if(console.log("indices_json ",i),null!=i){var l=new FieldVal(null);for(var t in i){var r=i[t],a=RuleField.create_field(r),n=a[0];if(null==n){var u=t.match(ArrayRuleField.interval_regex);if(u){var d=u[1],o=u[3]||0;if(e.interval&&d!==e.interval){l.invalid(t,FieldVal.create_error(ValidationRule.errors.interval_conflict,{},d,e.interval));continue}e.interval=d,e.interval_offsets[o]=r}else{var s=t.match(ArrayRuleField.integer_regex);if(s){var c=s[1];e.indices[c]=r}else"*"===t?e.indices["*"]=r:l.invalid(t,FieldVal.create_error(ValidationRule.errors.invalid_indices_format,{}))}}else l.invalid(t,n)}var f=l.end();f&&e.validator.invalid("indices",f)}return e.checks.push(function(i){for(var l=new FieldVal(i),t=0;t<i.length;t++){var r=e.rule_for_index(t);r.validate_as_field(t,l)}var a=l.end();return a}),e.validator.end()},"undefined"!=typeof module&&(module.exports=ArrayRuleField),"function"==typeof require&&(extend=require("extend"),BasicRuleField=require("./BasicRuleField")),extend(ChoiceRuleField,BasicRuleField),ChoiceRuleField.prototype.create_ui=function(e){var i=this;return i.json.choices=i.choices,i.ui_field=new ChoiceField(i.display_name||i.name,i.json),i.container=i.ui_field.container,e.add_field(i.name,i),i.ui_field},ChoiceRuleField.prototype.init=function(){var e=this;return e.allow_empty=e.validator.get("allow_empty",BasicVal.boolean(!1)),e.empty_message=e.validator.get("empty_message",BasicVal.string(!1)),e.choices=e.validator.get("choices",BasicVal.array(!0)),void 0!==e.choices&&e.checks.push(BasicVal.one_of(e.choices,{stop_on_error:!1})),e.validator.end()},"undefined"!=typeof module&&(module.exports=ChoiceRuleField),"function"==typeof require&&(extend=require("extend"),BasicRuleField=require("./BasicRuleField")),extend(BooleanRuleField,BasicRuleField),BooleanRuleField.prototype.create_ui=function(e){var i=this;return i.ui_field=new BooleanField(i.display_name||i.name,i.json),i.container=i.ui_field.container,e.add_field(i.name,i),i.ui_field},BooleanRuleField.prototype.init=function(){var e=this;return e.checks.push(BasicVal.boolean(e.required)),e.equal_to=e.validator.get("equal_to",BasicVal.boolean(!1)),void 0!==e.equal_to&&e.checks.push(BasicVal.equal_to(e.equal_to)),e.validator.end()},"undefined"!=typeof module&&(module.exports=BooleanRuleField),"function"==typeof require&&(extend=require("extend"),BasicRuleField=require("./BasicRuleField")),extend(EmailRuleField,BasicRuleField),EmailRuleField.prototype.create_ui=function(e){var i=this;return i.ui_field=new TextField(i.display_name||i.name,i.json),i.container=i.ui_field.container,e.add_field(i.name,i),i.ui_field},EmailRuleField.prototype.init=function(){var e=this;return e.checks.push(BasicVal.string(e.required),BasicVal.email()),e.validator.end()},"undefined"!=typeof module&&(module.exports=EmailRuleField),"function"==typeof require&&(FieldVal=require("fieldval"),BasicVal=require("fieldval-basicval"),RuleField=require("./fields/RuleField")),ValidationRule.errors={interval_conflict:function(e,i){return{error:501,error_message:"Only one interval can be used.",interval:e,existing:i}},invalid_indices_format:function(){return{error:502,error_message:"Invalid format for an indices rule."}}},ValidationRule.RuleField=RuleField,ValidationRule.prototype.init=function(e,i){var l=this,t=RuleField.create_field(e,i);return t[0]?t[0]:void(l.field=t[1])},ValidationRule.prototype.create_form=function(){var e=this;if(FVForm){var i=new FVForm;return e.field.create_ui(i,i),i}},ValidationRule.prototype.validate=function(e){var i=this,l=i.field.validate(e);return l},"undefined"!=typeof module&&(module.exports=ValidationRule),RuleField.add_field_type({name:"text",display_name:"Text","class":"undefined"!=typeof TextRuleField?TextRuleField:require("./fields/TextRuleField")}),RuleField.add_field_type({name:"string",display_name:"String","class":"undefined"!=typeof TextRuleField?TextRuleField:require("./fields/TextRuleField")}),RuleField.add_field_type({name:"boolean",display_name:"Boolean","class":"undefined"!=typeof BooleanRuleField?BooleanRuleField:require("./fields/BooleanRuleField")}),RuleField.add_field_type({name:"number",display_name:"Number","class":"undefined"!=typeof NumberRuleField?NumberRuleField:require("./fields/NumberRuleField")}),RuleField.add_field_type({name:"object",display_name:"Object","class":"undefined"!=typeof ObjectRuleField?ObjectRuleField:require("./fields/ObjectRuleField")}),RuleField.add_field_type({name:"array",display_name:"Array","class":"undefined"!=typeof ArrayRuleField?ArrayRuleField:require("./fields/ArrayRuleField")}),RuleField.add_field_type({name:"choice",display_name:"Choice","class":"undefined"!=typeof ChoiceRuleField?ChoiceRuleField:require("./fields/ChoiceRuleField")}),RuleField.add_field_type({name:"email",display_name:"Email","class":"undefined"!=typeof EmailRuleField?EmailRuleField:require("./fields/EmailRuleField")});